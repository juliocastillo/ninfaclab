<html>
    <head>
        <title></title>
    </head>
    <body class="PageBODY">
        <form method="POST" action="{FileName}" name="frm" id="frm" style="background-color:white;" autocomplete="off">
            <div style="box-shadow: 10px 10px 5px grey; border: 1px seagreen solid;  border-radius: 1px; width:1024px; position: relative;"> 
                <div id='frm_errorloc' class='frm_strings' style="background-color:orange; text-align: center"></div>
                <div>
                    <input type="hidden" name="id" id="id" value="{id}">
                    <table style="width:100%; border-color: black; border-width: 1px">
                        <tr>
                            <td colspan="6" align="center" style="border: 1px gainsboro outset; background: skyblue">
                                <font class="FormHeaderFONT">Datos del paciente</font>
                            </td>
                        </tr>
                        <tr>
                            <td style="height: 35px;"><strong>Paciente:</strong></td>
                            <td>
                                <select name="id_paciente" id="id_paciente" style="width: 400px; height: 24px; font-size: medium;" required >
                                    <option value=""></option>
                                    {id_paciente}
                                </select>
                                <a href="#" onclick="getPaciente(document.frm.id_paciente.value)">
                                    <img src='public/images/load.png' alt='abrir' height='20' width='20'>
                                </a>
                            </td>
                            <td><strong>Edad:</strong></td>
                            <td colspan="3">
                                <input type="text" value="{edad}" name="edad" id="edad" style="width: 50px;" />
                                <strong>Sexo:</strong>
                                <select name="id_sexo" id="id_sexo">
                                    <option value=""></option>
                                    {id_sexo}
                                </select>
                                <strong>Entrega:</strong>
                                <select name="id_lugarentrega" id="id_lugarentrega" >
                                    {id_lugarentrega}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td style="height: 35px;"><strong>Empresa:</strong></td>
                            <td>
                                <select name="id_empresa" id="id_empresa" style="width: 400px; height: 24px; font-size: medium;" required >
                                    <option value=""></option>
                                    {id_empresa}
                                </select>
                            </td>
                            <td colspan="4"><strong>Tipo empresa:</strong>

                                <select name="id_tipoempresa" id="id_tipoempresa" >
                                    {id_tipoempresa}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td style="height: 35px;"><strong>Medico:</strong></td>
                            <td>
                                <select name="id_medico" id="id_medico" style="width: 400px; height: 24px; font-size: medium;" required >
                                    <option value=""></option>
                                    {id_medico}
                                </select>

                            </td>
                            <td><strong>Procedencia:</strong></td>
                            <td>
                                <select name="id_procedencia" id="id_procedencia" >
                                    {id_procedencia}
                                </select>
                            </td>
                            <td><strong>Servicio:</strong></td>
                            <td>
                                <select name="id_servicio" id="id_servicio" >
                                    {id_servicio}
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <br>
            <div style="box-shadow: 10px 10px 5px grey; border: 1px seagreen solid;  border-radius: 1px; width: 1024px; position: relative;"> 
                <div id='frm_errorloc' class='frm_strings' style="background-color:orange; text-align: center"></div>
                <div>
                    <input type="hidden" name="id" id="id" value="{id}">
                    <table style="width:100%;">
                        <tr>
                            <td colspan="6" align="center" style="border: 1px gainsboro outset; background: skyblue">
                                <font class="FormHeaderFONT">Pruebas de la solicitud</font>
                            </td>
                        </tr>
                        <tr>
                            <td style="height: 70px; background-color: gainsboro;">
                                <strong>Pruebas de laboratorio</strong><br>
                                <select name="id_pruebaslab" id="id_pruebaslab" style="height: 24px; font-size: medium;" onchange="getPrecio(this.value);">
                                    <option value=""></option>
                                    {id_pruebaslab}
                                </select>
                            </td>
                            <td style="height: 70px; background-color: gainsboro;">
                                <strong>Precio</strong><br>
                                <input type="text" value="" name="precio" id="precio" style="width: 75px;" />
                            </td>
                            <td style="height: 70px; background-color: gainsboro;">
                                <a href="#" onclick="addDetalle();">
                                    <img src='public/images/add.jpg' alt='abrir' height='30' width='30'>
                                </a>
                            </td>
                            <td style="height: 70px; background-color: gainsboro;"><strong>Perfil:</strong></td>
                            <td style="height: 70px; background-color: gainsboro;">
                                <select name="id_perfil" id="id_perfil">
                                    <option value=""></option>
                                    {id_perfil}
                                </select>
                                <a href="#">
                                    <img src='public/images/list.png' alt='abrir' height='25' width='25'>
                                </a>
                            </td>
                        </tr>

                    </table>
                </div>
            </div>
            <div id="div_mess"></div>
            <br>

            <div style="width: 1024px;"> 
                <table class="display compact" style="width: 100%;" id="tbldetalle">
                    <thead>
                    <th width="50px"></th>
                    <th>DESCRIPCION</th>
                    <th width="100px">PRECIO</th>
                    <th width="75px"></th>
                    </thead>
                    <tbody>
                        {tblbody}
                    </tbody>
                </table>
            </div>

            <div style="background-color: gainsboro; width: 1024px; text-align: right;">
                <input type="button" value="Buscar solicitud" onclick="searchSolicitud()" class="btn btn-success"/>
                <label>Sumas: </label><input type="text" id="sumas" name="sumas" value="{sumas}" style="width: 100px;">$
                <label>Descuento: </label><input type="text" name="descuento" id="descuento" style="width: 50px;" value="{descuento}">%
                <label> Total a pagar: </label><input type="text" name="total" id="total" value="{total}" style="width: 100px;">$
                <button type="button" onclick="calcular_totales();"><img src='public/images/sigma.svg' alt='abrir' height='25' width='25'></button>
                <input type="submit" value="Guardar" class="btn btn-success"/>
                <input type="button" value="Imprimir" class="btn btn-success"/>
                <input type="button" value="Nuevo" onclick="window.location = 'labSolicitud.php'" class="btn btn-primary"/>
            </div>
        </form>
        <script language="Javascript">
            /*
             * inicializaDataTable(combobox, pageLength, lengthChange, searching)
             */
            inicializaDataTable('tbldetalle', 5, false, false);

            function searchSolicitud() {
                miVentana = window.open("labSolicitudBuscar.php", "nombrePop-Up", "width=600,height=500, top=85,left=50");
            }

            function getPaciente(value) {
                if (value !== "") {
                    $.getJSON("buscadorAjax.php", {"id": value, "bus": 'paciente'})
                            .done(function (data) {
                                document.frm.id.value = data.obj.id;
                                document.frm.id_empresa.value = $("#id_empresa").select2("val", data.obj.id_empresa);
                                document.frm.edad.value = data.obj.edad;
                                document.frm.id_sexo.value = data.obj.id_sexo;
                                document.frm.id_tipoempresa.value = data.obj.id_tipoempresa;
                            })
                            .fail(function (jqXHR, textStatus, errorThrown) {
                                if (console && console.log) {
                                    console.log("Algo ha fallado: " + textStatus);
                                }
                            });
                }
            }

            var subtotal = 0;
            function addDetalle() {
                pruebaslab = document.getElementById("id_pruebaslab");
                pruebaslab_codigo = pruebaslab.options[pruebaslab.selectedIndex].value;
                pruebaslab_text = pruebaslab.options[pruebaslab.selectedIndex].text;
                precio = document.getElementById("precio").value;
                if (parseFloat(precio) !== 0 && pruebaslab_codigo !== "") {
                    $(document).ready(function () {
                        var tabla = $('#tbldetalle').DataTable();
                        tabla.row.add([
                            "<input type='text' id='id_prueba' name='id_prueba[]' value='" + pruebaslab_codigo + "' style='width: 50px;' hidden> ",
                            pruebaslab_text,
                            "<input type='text' name='precio_prueba[]' value='" + precio + "' style='width: 75px;'> ",
                            "<input id='remove_item' type='button' value='Qutar' onclick='removeDetalle()'>",
                        ]).draw(false);
                    });

                } else {
                    alert('Seleccione prueba de laboratorio y precio')
                }
            }

            function removeDetalle() {
                var table = $('#tbldetalle').DataTable();
                $('#tbldetalle').on("click", "#remove_item", function () {
                    console.log($(this).parent());
                    table.row($(this)
                            .parents('tr'))
                            .remove()
                            .draw(false);
                });
            }

            $("#id_paciente").select2({
                placeholder: 'Buscar paciente',
                allowClear: true
            })

            $("#id_medico").select2({
                placeholder: 'Buscar medico',
                allowClear: true
            })

            $(document).ready(function () {
                $('#id_empresa').select2({
                    placeholder: 'Seleccionar empresa',
                    allowClear: true
                });
            });

            $("#id_pruebaslab").select2({
                placeholder: 'Seleccione las pruebas',
                allowClear: true
            }
            )
            var frmvalidator = new Validator("frm");
            frmvalidator.EnableOnPageErrorDisplaySingleBox();
            frmvalidator.EnableMsgsTogether();
            frmvalidator.addValidation("id_paciente", "dontselect=000", "Seleccione: Paciente");

            function getPrecio(id_pruebaslab) {
                id_tipoempresa = document.frm.id_tipoempresa.value;
                if (id_pruebaslab !== "" && id_tipoempresa !== "") {
                    $.getJSON("buscadorAjax.php", {"id_pruebaslab": id_pruebaslab, "id_tipoempresa": id_tipoempresa, "bus": 'precio'})
                            .done(function (data) {
                                document.frm.precio.value = data.obj.precio;
                                if (document.frm.cantidad.value === "") {
                                    document.frm.cantidad.value = 1;
                                }
                            })
                            .fail(function (jqXHR, textStatus, errorThrown) {
                                if (console && console.log) {
                                    console.log("Algo ha fallado: " + textStatus);
                                }
                            });
                }
            }

            function calcular_totales()
            {
                var sumas = 0;
                var descuento = 0;
                var total = 0;
                var descuento = parseFloat($('#descuento').val());

                $("input[name='precio_prueba[]'").each(function ()
                {
                    subtotal = parseFloat($(this).val());
                    sumas = sumas + subtotal;
                });

                document.getElementById('sumas').value = parseFloat(sumas).toFixed(2);
                if (parseInt(descuento) === 0) {
                    document.getElementById('total').value = parseFloat(sumas).toFixed(2)
                } else {
                    document.getElementById('total').value = parseFloat(parseFloat(sumas).toFixed(2) - ((parseFloat(sumas).toFixed(2) * parseFloat(descuento).toFixed(2)) / 100)).toFixed(2);
                }
            }
        </script>
    </body>
</html>
